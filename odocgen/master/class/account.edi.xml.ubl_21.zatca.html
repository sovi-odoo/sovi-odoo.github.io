<!doctype html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>account.edi.xml.ubl_21.zatca - odocgen</title><link rel="stylesheet" href="class.css" /></head><body><h1>account.edi.xml.ubl_21.zatca</h1><p>Inherited in: odoo/addons/l10n_sa_edi/models/account_edi_xml_ubl_21_zatca.py<br/></p><hr/><h2>Inherited: odoo/addons/l10n_sa_edi/models/account_edi_xml_ubl_21_zatca.py</h2><h3>Methods</h3><details><summary id="m-_apply_invoice_line_filter">_apply_invoice_line_filter(self, invoice_line) <span class="position">@ line 197</span></summary><pre>Override to filter out down payment lines</pre></details><details><summary id="m-_apply_invoice_tax_filter">_apply_invoice_tax_filter(self, base_line, tax_values) <span class="position">@ line 187</span></summary><pre>Override to filter out withholding tax</pre></details><details><summary id="m-_export_invoice_filename">_export_invoice_filename(self, invoice) <span class="position">@ line 135</span></summary><pre>Generate the name of the invoice XML file according to ZATCA business rules:
Seller Vat Number (BT-31), Date (BT-2), Time (KSA-25), Invoice Number (BT-1)</pre></details><details><summary id="m-_export_invoice_vals">_export_invoice_vals(self, invoice) <span class="position">@ line 254</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><details><summary id="m-_get_delivery_vals_list">_get_delivery_vals_list(self, invoice) <span class="position">@ line 91</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><details><summary id="m-_get_invoice_line_item_vals">_get_invoice_line_item_vals(self, line, taxes_vals) <span class="position">@ line 309</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><details><summary id="m-_get_invoice_line_vals">_get_invoice_line_vals(self, line, line_id, taxes_vals) <span class="position">@ line 330</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><details><summary id="m-_get_invoice_payment_means_vals_list">_get_invoice_payment_means_vals_list(self, invoice) <span class="position">@ line 118</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><details><summary id="m-_get_invoice_payment_terms_vals_list">_get_invoice_payment_terms_vals_list(self, invoice) <span class="position">@ line 422</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><details><summary id="m-_get_invoice_tax_totals_vals_list">_get_invoice_tax_totals_vals_list(self, invoice, taxes_vals) <span class="position">@ line 370</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs.
In this case, we make sure the tax amounts are always absolute (no negative values)</pre></details><details><summary id="m-_get_partner_address_vals">_get_partner_address_vals(self, partner) <span class="position">@ line 126</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><ul id="m-_get_partner_contact_vals"><li>_get_partner_contact_vals(self, partner) <span class="position">@ line 97</span></li></ul><details><summary id="m-_get_partner_party_identification_vals_list">_get_partner_party_identification_vals_list(self, partner) <span class="position">@ line 103</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><details><summary id="m-_get_partner_party_tax_scheme_vals_list">_get_partner_party_tax_scheme_vals_list(self, partner, role) <span class="position">@ line 177</span></summary><pre>Override to return an empty list if the partner is a customer and their country is not KSA.
This is according to KSA Business Rule BR-KSA-46 which states that in the case of Export Invoices,
the buyer VAT registration number or buyer group VAT registration number must not exist in the Invoice</pre></details><details><summary id="m-_get_tax_category_list">_get_tax_category_list(self, invoice, taxes) <span class="position">@ line 249</span></summary><pre>Override to filter out withholding taxes</pre></details><details><summary id="m-_get_tax_unece_codes">_get_tax_unece_codes(self, invoice, tax) <span class="position">@ line 390</span></summary><pre>Override to include/update values specific to ZATCA's UBL 2.1 specs</pre></details><details><summary id="m-_l10n_sa_generate_invoice_xml_hash">_l10n_sa_generate_invoice_xml_hash(self, xml_content, mode) <span class="position">@ line 70</span></summary><pre>Generate the b64 encoded sha256 hash of a given xml string:
- First: Transform the xml content using a pre-hash_invoice.xsl file
- Second: Canonicalize the transformed xml content using the c14n method
- Third: hash the canonicalized content using the sha256 algorithm then encode it into b64 format</pre></details><details><summary id="m-_l10n_sa_generate_invoice_xml_sha">_l10n_sa_generate_invoice_xml_sha(self, xml_content) <span class="position">@ line 42</span></summary><pre>Transform, canonicalize then hash the invoice xml content using the SHA256 algorithm,
then return the hashed content</pre></details><details><summary id="m-_l10n_sa_get_additional_tax_total_vals">_l10n_sa_get_additional_tax_total_vals(self, invoice, vals) <span class="position">@ line 290</span></summary><pre>For ZATCA, an additional TaxTotal element needs to be included in the UBL file
(Only for the Invoice, not the lines)

If the invoice is in a different currency from the one set on the company (SAR), then the additional
TaxAmount element needs to hold the tax amount converted to the company's currency.

Business Rules: BT-110 & BT-111</pre></details><details><summary id="m-_l10n_sa_get_billing_reference_vals">_l10n_sa_get_billing_reference_vals(self, invoice) <span class="position">@ line 168</span></summary><pre>Get the billing reference vals required to render the BillingReference for credit/debit notes</pre></details><details><summary id="m-_l10n_sa_get_invoice_transaction_code">_l10n_sa_get_invoice_transaction_code(self, invoice) <span class="position">@ line 145</span></summary><pre>Returns the transaction code string to be inserted in the UBL file follows the following format:
- NNPNESB, in compliance with KSA Business Rule KSA-2, where:
- NN (positions 1 and 2) = invoice subtype:
- 01 for tax invoice
- 02 for simplified tax invoice
- E (position 5) = Exports invoice transaction, 0 for false, 1 for true</pre></details><details><summary id="m-_l10n_sa_get_invoice_type">_l10n_sa_get_invoice_type(self, invoice) <span class="position">@ line 159</span></summary><pre>Returns the invoice type string to be inserted in the UBL file
- 383: Debit Note
- 381: Credit Note
- 388: Invoice</pre></details><details><summary id="m-_l10n_sa_get_line_prepayment_vals">_l10n_sa_get_line_prepayment_vals(self, line, taxes_vals) <span class="position">@ line 315</span></summary><pre>If an invoice line is linked to a down payment invoice, we need to return the proper values
to be included in the UBL</pre></details><details><summary id="m-_l10n_sa_get_monetary_vals">_l10n_sa_get_monetary_vals(self, invoice, vals) <span class="position">@ line 218</span></summary><pre>Calculate the invoice monteray amount values, including prepaid amounts (down payment)</pre></details><details><summary id="m-_l10n_sa_get_namespaces">_l10n_sa_get_namespaces(self) <span class="position">@ line 27</span></summary><pre>Namespaces used in the final UBL declaration, required to canonalize the finalized XML document of the Invoice</pre></details><details><summary id="m-_l10n_sa_get_payment_means_code">_l10n_sa_get_payment_means_code(self, invoice) <span class="position">@ line 114</span></summary><pre>Return payment means code to be used to set the value on the XML file</pre></details><details><summary id="m-_l10n_sa_get_prepaid_amount">_l10n_sa_get_prepaid_amount(self, invoice, vals) <span class="position">@ line 203</span></summary><pre>Calculate the down-payment amount according to ZATCA rules</pre></details><details><summary id="m-_l10n_sa_get_previous_invoice_hash">_l10n_sa_get_previous_invoice_hash(self, invoice) <span class="position">@ line 84</span></summary><pre>Function that returns the Base 64 encoded SHA256 hash of the previously submitted invoice</pre></details><script src="class.js"></script></body></html>
